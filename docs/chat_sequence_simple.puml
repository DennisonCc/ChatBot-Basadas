@startuml Chat_Sequence_Flow_Simple
skinparam backgroundColor #FFFFFF
skinparam defaultFontColor #000000
skinparam SequenceMessageAlign center

title ðŸ’¬ Flujo de ConversaciÃ³n del Chatbot (Simple)

actor "ðŸ‘¤ Usuario" as USER
participant "ðŸ“± ChatbotWidget" as WIDGET
participant "ðŸ›£ï¸ FastAPI" as API
participant "ðŸ’¬ ChatService" as SVC
participant "ðŸ¤– PydanticAgent" as AGENT
participant "â˜ï¸ NVIDIA NIM" as NVIDIA
participant "ðŸ”— FlaskGateway" as GW
participant "ðŸ”µ Flask API" as FLASK

autonumber

== ðŸ“© Mensaje del Usuario ==

USER -> WIDGET : Escribe "Â¿QuiÃ©nes estÃ¡n en pausa hoy?"
activate WIDGET

WIDGET -> API : POST /chat\n{"message": "...", "current_screen": "Tiempos Fuera"}
activate API

API -> SVC : process_message(ChatRequest)
activate SVC

SVC -> AGENT : get_response(message, screen)
activate AGENT

== ðŸ§  Procesamiento IA ==

AGENT -> AGENT : Prepara contexto

AGENT -> NVIDIA : API call con tools disponibles
activate NVIDIA

note right of NVIDIA
    El LLM decide usar
    **get_pause_history** tool
end note

NVIDIA --> AGENT : tool_call: get_pause_history(fecha=hoy)
deactivate NVIDIA

== ðŸ”§ Tool Execution ==

AGENT -> GW : get_pause_history(ci='%', fecha='2026-02-07')
activate GW

GW -> FLASK : GET /api/pausas?fecha_inicio=2026-02-07&fecha_fin=2026-02-07
activate FLASK

FLASK --> GW : [{"id": 1, "empleado_nombre": "Juan", "tipo": "ALMUERZO"}, ...]
deactivate FLASK

GW --> AGENT : List[PauseRecord]
deactivate GW

== ðŸŽ¯ GeneraciÃ³n de Respuesta ==

AGENT -> NVIDIA : tool_result + continuar generaciÃ³n
activate NVIDIA

NVIDIA --> AGENT : "Hoy hay 3 empleados en pausa..."
deactivate NVIDIA

AGENT --> SVC : response_text
deactivate AGENT

SVC --> API : ChatResponse
deactivate SVC

API --> WIDGET : {"response": "Hoy hay 3 empleados..."}
deactivate API

WIDGET --> USER : Muestra respuesta formateada
deactivate WIDGET

@enduml
